<!DOCTYPE html>
<html>
<head>
    <title>Estimation Board</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("SizesField",{extend:"Ext.form.field.Base",alias:"widget.sizesfield",requires:["Rally.ui.Button"],fieldSubTpl:'<div id="{id}"></div>',cls:"sizes",config:{value:void 0},onDestroy:function(){this._sizesContainer&&(this._sizesContainer.destroy(),delete this._sizesContainer),this.callParent(arguments)},onRender:function(){this.callParent(arguments),this._sizesContainer=Ext.create("Ext.Container",{renderTo:this.inputEl,cls:"sizes-container",items:this._buildRows()})},getSubmitData:function(){var e={};return e[this.name]=Ext.JSON.encode(_.map(Ext.ComponentQuery.query("container",this._sizesContainer),function(e){var t=Ext.ComponentQuery.query("rallytextfield",e)[0],i=Ext.ComponentQuery.query("rallynumberfield",e)[0];return{text:t.getValue(),value:i.getValue()}})),e},_buildRows:function(){return[{xtype:"component",margin:"0 0 5px 0",html:'<span class="label-header">Name</span><span class="plan-est-header">Plan Est</span>'}].concat(_.map(Ext.JSON.decode(this._value),function(e){return this._buildRow(e)},this))},_buildRow:function(e){return{xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",border:!1,frame:!1,cls:"row-btn plus",disabled:!1,itemId:"plusButton",iconCls:"icon-plus",listeners:{click:this._addRow,scope:this}},{xtype:"rallybutton",border:!1,cls:"row-btn minus",frame:!1,iconCls:"icon-minus",itemId:"minusButton",listeners:{click:this._removeRow,scope:this}},{xtype:"rallytextfield",width:100,value:e&&e.text},{xtype:"rallynumberfield",width:50,margin:"0 0 0 10px",value:e&&e.value}]}},_addRow:function(e){var t=e.up(),i=t.up(),n=i.items.indexOf(t);i.insert(n+1,this._buildRow()),this._adjustSize()},_removeRow:function(e){e.up().destroy(),this._adjustSize()},_adjustSize:function(){var e=this.up("rallyappsettings");e.fireEvent("appsettingsready",e)},setValue:function(e){this.callParent(arguments),this._value=e}});
                Ext.define("RowSettingsField",{alias:"widget.rowsettingsfield",extend:"Ext.form.FieldContainer",requires:["Rally.ui.CheckboxField","Rally.ui.combobox.ComboBox","Rally.ui.plugin.FieldValidationUi","Rally.data.ModelFactory","Rally.data.wsapi.ModelBuilder"],mixins:{field:"Ext.form.field.Field"},layout:"hbox",cls:"row-settings",config:{value:void 0,isAllowedFieldFn:Ext.emptyFn,explicitFields:[],modelNames:["userstory","defect"],whiteListFields:[]},initComponent:function(){this.callParent(arguments),this.mixins.field.initField.call(this),this.add([{xtype:"rallycheckboxfield",name:"showRows",boxLabel:"",margin:"0",submitValue:!1,value:this.getValue().showRows,listeners:{change:function(e,t){this.down("rallycombobox").setDisabled(!t)},scope:this}},{xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],name:"rowsField",margin:"0 6px",width:130,emptyText:"Choose Field...",displayField:"name",valueField:"value",disabled:"true"!==this.getValue().showRows,editable:!1,submitValue:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[]}}]),this._loadModels()},_loadModels:function(){Rally.data.ModelFactory.getModels({types:this.getModelNames(),context:this.context,success:this._onModelsRetrieved,scope:this})},_onModelsRetrieved:function(e){var t=_.uniq(Ext.Array.merge(this.explicitFields,this._getRowableFields(_.values(e))),"name"),i=this.down("rallycombobox");i.getStore().loadData(_.sortBy(t,"name")),i.setValue(this.getValue().rowsField),this.fireEvent("ready",this)},_getRowableFields:function(e){var t=Rally.data.wsapi.ModelBuilder.buildCompositeArtifact(e,this.context),i=t.getFields(),l=_.filter(i,function(i){var l=i.attributeDefinition;return l&&!l.Hidden&&l.Sortable&&(t.getModelsForField(i).length===e.length&&this.isAllowedFieldFn(i)||_.contains(this.whiteListFields,i.displayName))},this);return _.map(l,function(e){return{name:e.displayName,value:e.name}})},getSubmitData:function(){var e={},t=this.down("rallycheckboxfield"),i=this.down("rallycombobox"),l=t.getValue()&&!_.isEmpty(i.getValue());return e[t.name]=l,l&&(e[i.name]=i.getValue()),e},refreshWithNewModelType:function(e){this.setModelNames([e]),this._loadModels()}});
                Ext.define("Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.TextField","Rally.ui.NumberField","RowSettingsField","Rally.data.wsapi.Filter","SizesField"],getFields:function(e){return[{name:"sizes",xtype:"sizesfield",fieldLabel:"Columns"},{name:"groupHorizontallyByField",xtype:"rowsettingsfield",fieldLabel:"Swimlanes",mapsToMultiplePreferenceKeys:["showRows","rowsField"],readyEvent:"ready",isAllowedFieldFn:function(e){var t=e.attributeDefinition;return(t.Custom&&(t.Constrained||"string"!==t.AttributeType.toLowerCase())||t.Constrained||_.contains(["quantity","boolean"],t.AttributeType.toLowerCase())||!t.Constrained&&"object"===t.AttributeType.toLowerCase())&&!_.contains(["web_link","text","date"],t.AttributeType.toLowerCase())&&!_.contains(["PortfolioItemType","LastResult"],t.ElementName)},handlesEvents:{typeselected:function(e,t){this.refreshWithNewModelType(e,t)}}},{type:"query"}]}});
                Ext.define("EstimationBoardApp",{extend:"Rally.app.App",alias:"widget.boardapp",requires:["Rally.ui.cardboard.plugin.FixedHeader","Rally.ui.gridboard.GridBoard","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.GridBoardCustomFilterControl","Rally.ui.gridboard.plugin.GridBoardFieldPicker","Rally.data.util.Sorter","Settings","Rally.clientmetrics.ClientMetricsRecordable"],mixins:["Rally.clientmetrics.ClientMetricsRecordable"],cls:"customboard",autoScroll:!1,layout:"fit",config:{defaultSettings:{types:["HierarchicalRequirement","Defect","DefectSuite"],showRows:!1,sizes:Ext.JSON.encode([{text:"XS",value:1},{text:"S",value:2},{text:"M",value:3},{text:"L",value:5},{text:"XL",value:8}])}},launch:function(){Rally.data.ModelFactory.getModels({types:this.getSetting("types"),context:this.getContext().getDataContext()}).then({success:function(t){this.models=t,this.add(this._getGridBoardConfig())},scope:this})},_getGridBoardConfig:function(){var t=this.getContext(),e=this.getSetting("types"),i={xtype:"rallygridboard",stateful:!1,toggleState:"board",cardBoardConfig:this._getBoardConfig(),plugins:[{ptype:"rallygridboardaddnew",addNewControlConfig:{stateful:!0,stateId:t.getScopedStateId("board-add-new")}},{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:t.getScopedStateId("board-filters"),modelNames:e,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner","ModelType"],addQuickFilterConfig:{whiteListFields:["Milestones","Tags"]}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:["Milestones","Tags"]}}}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",boardFieldBlackList:["Successors","Predecessors","DisplayColor"],modelNames:e}],context:t,modelNames:e,storeConfig:{filters:this._getFilters()},listeners:{load:this._onLoad,scope:this}};return this.getEl()&&(i.height=this.getHeight()),i},_onLoad:function(){this.recordComponentReady({miscData:{type:this.getSetting("type"),columns:this.getSetting("groupByField"),rows:this.getSetting("showRows")&&this.getSetting("rowsField")||""}})},_getBoardConfig:function(){var t={margin:"10px 0 0 0",attribute:"PlanEstimate",context:this.getContext(),cardConfig:{editable:!0,showIconMenus:!0},loadMask:!0,plugins:[{ptype:"rallyfixedheadercardboard"}],storeConfig:{sorters:Rally.data.util.Sorter.sorters(this.getSetting("order"))},columnConfig:{columnHeaderConfig:{headerTpl:"{size}"}},columns:_.map([{text:"No Estimate",value:null}].concat(Ext.JSON.decode(this.getSetting("sizes"))),function(t){return{value:t.value,columnHeaderConfig:{headerData:{size:t.text}}}})};return this.getSetting("showRows")&&Ext.merge(t,{rowConfig:{field:this.getSetting("rowsField"),sortDirection:"ASC"}}),this._shouldDisableRanking()&&(t.enableRanking=!1,t.enableCrossColumnRanking=!1,t.cardConfig.showRankMenuItems=!1),t},getSettingsFields:function(){return Settings.getFields(this.getContext())},_shouldDisableRanking:function(){return!this.getSetting("showRows")||this.getSetting("showRows")&&"workproduct"!==this.getSetting("rowsField").toLowerCase()},_addBoard:function(){var t=this.down("rallygridboard");t&&t.destroy(),this.add(this._getGridBoardConfig())},onTimeboxScopeChange:function(t){this.callParent(arguments),this._addBoard()},_getFilters:function(){var t=[],e=this.getContext().getTimeboxScope();return this.getSetting("query")&&t.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),e&&_.all(this.models,function(t){return t.hasField(Ext.String.capitalize(e.getType()))})&&t.push(e.getQueryFilter()),t}});

            Rally.launchApp('EstimationBoardApp', {
                name:"Estimation Board",
                parentRepos:"",
                version:"1.0.1"
            });

        });
    </script>


    <style type="text/css">
        .customboard{overflow-y:hidden}.sizes .x-field-label-cell{vertical-align:top}.sizes .label-header{margin-left:60px;font-family:NotoSansBold;font-size:12px}.sizes .plan-est-header{margin-left:70px;font-family:NotoSansBold;font-size:12px}.sizes .sizes-container{margin-top:5px}.row-btn{background-color:transparent;font-size:14px;height:26px;width:28px;float:left;padding:2px 0 0 0}.row-btn .btn-button{border:0 !important}.row-btn.minus{color:#666666}.row-btn.plus{color:#00A9E0}.row-btn.plus:hover{color:#29beff}.row-btn.plus.item-disabled,.row-btn.plus.item-disabled:hover{cursor:default}.row-btn.plus.item-disabled span,.row-btn.plus.item-disabled:hover span{color:#666666}
    </style>
</head>
<body>
</body>
</html>
